{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "insert_station_on_segment_sn_v1",
  "title": "InsertStationOnSegmentSN",
  "description": "Payload for insert_station_on_segment_sn â€” supports Variant 2 (full) and Variant 2.1 (engineering).",
  "type": "object",
  "properties": {
    "meta": {
      "type": "object",
      "properties": {
        "snapshot_in_id": { "type": "string" },
        "idempotency_key": { "type": "string" },
        "ui": { "type": "object" },
        "timestamp_utc": { "type": "string", "format": "date-time" }
      },
      "required": ["snapshot_in_id", "idempotency_key"]
    },
    "trunk_ref": {
      "type": "object",
      "properties": {
        "trunk_id": { "type": "string" },
        "terminal_from_id": { "type": ["string", "null"] },
        "terminal_to_id": { "type": ["string", "null"] },
        "segment_order_index_expected": { "type": ["integer", "null"] }
      },
      "required": ["trunk_id"]
    },
    "segment_target": {
      "type": "object",
      "properties": {
        "segment_id": { "type": "string" },
        "cut": {
          "type": "object",
          "properties": {
            "mode": { "type": "string", "enum": ["FRACTION", "DISTANCE_M", "WORLD_POINT"] },
            "fraction_0_1": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
            "distance_m": { "type": ["number", "null"] },
            "world_point": { "type": ["object", "null"] }
          },
          "required": ["mode"]
        },
        "segment_length": {
          "type": "object",
          "properties": {
            "value": { "type": ["number", "null"] },
            "unit": { "type": "string", "const": "m" }
          }
        },
        "cut_resolution_policy": {
          "type": "object",
          "properties": {
            "snap_to_existing_node_threshold_m": { "type": "number" },
            "if_within_threshold": { "type": "string", "enum": ["SNAP_TO_NODE", "REJECT_WITH_ERROR"] },
            "if_hits_port_exactly": { "type": "string", "enum": ["SNAP_TO_PORT", "SNAP_TO_NODE"] },
            "deterministic_tie_breaker": { "type": "string" }
          }
        }
      },
      "required": ["segment_id", "cut"]
    },
    "embedding_intent": {
      "type": "object",
      "properties": {
        "continuity": { "type": "string", "enum": ["CIAGLOSC_IN_OUT", "ODNOGA"] },
        "branch_ports_allowed": { "type": "boolean", "default": false }
      }
    },
    "station_spec": {
      "type": "object",
      "properties": {
        "station_type": { "type": "string", "enum": ["A", "B", "C", "D"] },
        "station_role": { "type": "string" },
        "station_name": { "type": "string" },
        "sn_voltage_kv": { "type": "number", "exclusiveMinimum": 0 },
        "nn_voltage_kv": { "type": "number", "exclusiveMinimum": 0 },
        "port_plan": {
          "type": "object",
          "properties": {
            "ports_declared": { "type": "array", "items": { "type": "string" } },
            "port_rules_by_station_type": { "type": "string" },
            "port_to_field_binding": { "type": "object" }
          }
        },
        "segment_split_policy": {
          "type": "object",
          "properties": {
            "left_segment_catalog_policy": { "type": "string" },
            "right_segment_catalog_policy": { "type": "string" },
            "right_segment_catalog_binding": { "$ref": "catalog_binding_schema.json" }
          }
        },
        "sn_fields_declared_order": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "field_key": { "type": "string" },
              "field_role": { "type": "string", "enum": ["LINIA_IN", "LINIA_OUT", "LINIA_ODG", "TRANSFORMATOROWE", "SPRZEGLO"] },
              "apparatus_plan": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "kind": { "type": "string" },
                    "catalog_binding": { "oneOf": [{ "$ref": "catalog_binding_schema.json" }, { "type": "null" }] }
                  },
                  "required": ["kind"]
                }
              },
              "ct_plan": {
                "type": "object",
                "properties": {
                  "present": { "type": "boolean" },
                  "catalog_binding": { "oneOf": [{ "$ref": "catalog_binding_schema.json" }, { "type": "null" }] }
                }
              },
              "vt_plan": {
                "type": "object",
                "properties": {
                  "present": { "type": "boolean" },
                  "catalog_binding": { "oneOf": [{ "$ref": "catalog_binding_schema.json" }, { "type": "null" }] }
                }
              },
              "line_catalog_binding": { "oneOf": [{ "$ref": "catalog_binding_schema.json" }, { "type": "null" }] }
            },
            "required": ["field_key", "field_role"]
          }
        },
        "transformer_spec": {
          "type": "object",
          "properties": {
            "create": { "type": "boolean" },
            "catalog_binding": { "$ref": "catalog_binding_schema.json" },
            "model_type": { "type": "string" },
            "tap_changer_present": { "type": "boolean" },
            "connection": {
              "type": "object",
              "properties": {
                "sn_field_key": { "type": "string" },
                "nn_bus_key": { "type": "string" }
              }
            }
          }
        },
        "nn_block_spec": {
          "type": "object",
          "properties": {
            "create_nn_bus": { "type": "boolean" },
            "main_device": {
              "type": "object",
              "properties": {
                "catalog_binding": { "$ref": "catalog_binding_schema.json" }
              }
            },
            "outgoing_fields": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "field_key": { "type": "string" },
                  "port_id": { "type": "string" },
                  "device": {
                    "type": "object",
                    "properties": {
                      "catalog_binding": { "$ref": "catalog_binding_schema.json" }
                    }
                  },
                  "creates_nn_segment": { "type": "boolean" },
                  "nn_segment_if_created": {
                    "type": ["object", "null"],
                    "properties": {
                      "length": { "type": "object" },
                      "catalog_binding": { "$ref": "catalog_binding_schema.json" }
                    }
                  }
                }
              }
            },
            "loads": { "type": "array" },
            "sources": { "type": "array" }
          }
        }
      },
      "required": ["station_type", "station_name", "sn_voltage_kv", "nn_voltage_kv"]
    },
    "options": {
      "type": "object",
      "properties": {
        "create_default_fields": { "type": "boolean" },
        "deterministic_id_policy": { "type": "string" },
        "numeric_stability": { "type": "object" }
      }
    }
  },
  "required": ["trunk_ref", "segment_target", "station_spec"]
}
