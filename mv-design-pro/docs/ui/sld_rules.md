# SLD (Single Line Diagram) Rules

**Reference:** SYSTEM_SPEC.md Section 9, Section 18, **wizard_screens.md (KANONICZNY)**
**Status:** CANONICAL

> **UWAGA:** Niniejszy dokument jest spójny z `wizard_screens.md` (wersja 2.0) i `powerfactory_ui_parity.md`.
> Tryby pracy SLD są 1:1 zmapowane na tryby systemowe opisane w Wizard.

---

## A. Zasady SLD (SLD Principles)

### A.1 Bijection: Symbol ↔ Model Object

**INVARIANT:** Each SLD symbol corresponds to exactly ONE NetworkModel object.

```
┌─────────────────────────────────────────────────────────────┐
│                     NetworkModel                             │
│  ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐        │
│  │ Bus_1 │ │ Bus_2 │ │Line_1 │ │Trafo_1│ │Source1│        │
│  └───────┘ └───────┘ └───────┘ └───────┘ └───────┘        │
│      ↕         ↕         ↕         ↕         ↕             │
│  ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐        │
│  │Symbol │ │Symbol │ │Symbol │ │Symbol │ │Symbol │        │
│  │ Bus_1 │ │ Bus_2 │ │Line_1 │ │Trafo_1│ │Source1│        │
│  └───────┘ └───────┘ └───────┘ └───────┘ └───────┘        │
│                        SLD Layer                            │
└─────────────────────────────────────────────────────────────┘
```

### A.2 Symbol Types

| Model Object | SLD Symbol | Visual Representation |
|--------------|------------|----------------------|
| Bus | BusSymbol | Horizontal bar (busbar) |
| LineBranch | LineSymbol | Single line with markers |
| TransformerBranch | TransformerSymbol | Circle(s) with windings |
| Switch | SwitchSymbol | Break symbol (open/closed) |
| Source | SourceSymbol | Circle with arrow (grid) |
| Load | LoadSymbol | Triangle (consumption) |

### A.3 No Helper Objects

**FORBIDDEN:**
- Junction points not backed by Bus
- Connection lines not backed by Branch
- Annotation symbols with implicit meaning
- Grouping frames with electrical meaning

**ALLOWED:**
- Text labels (pure annotation, no semantics)
- Position coordinates (layout only)
- Layer/grouping for visual organization (no electrical meaning)

### A.4 No Virtual Symbols

**FORBIDDEN:**

| Virtual Symbol | Why Forbidden | Correct Approach |
|----------------|---------------|------------------|
| "Virtual Bus" | No model object | Add real Bus to model |
| "PCC Marker" | PCC is interpretation | Analysis overlay |
| "Boundary Line" | No physical meaning | Analysis overlay |
| "Aggregated Feeder" | Hides topology | Show individual elements |

---

## B. Wyniki (Results Display)

### B.1 Results as Overlay

Solver results MUST be displayed as overlay on SLD, NOT as modifications to symbols:

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   Base Layer (SLD Symbols):                                 │
│                                                             │
│   ════╦════════════════════╦════                           │
│       ║                    ║                                │
│                                                             │
│   Overlay Layer (Results):                                  │
│                                                             │
│      [I=125A]           [I=98A]                            │
│      [U=14.8kV]         [U=15.1kV]                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### B.2 Overlay = Analysis Layer

Result overlays are generated by Analysis layer, not by Solver:

| Data Source | Overlay Type | Content |
|-------------|--------------|---------|
| PowerFlowResult | Current annotations | I values at branches |
| PowerFlowResult | Voltage annotations | U values at buses |
| ThermalAnalysis | Loading colors | Red/yellow/green |
| VoltageAnalysis | Violation markers | Over/under voltage |
| BoundaryIdentifier | PCC marker | Boundary indicator |

### B.3 No Results in Model

**BINDING:** Solver results MUST NOT be written to NetworkModel:

| Forbidden | Correct Approach |
|-----------|------------------|
| `Bus.calculated_voltage = 14.8` | Store in PowerFlowResult |
| `Branch.calculated_current = 125` | Store in PowerFlowResult |
| `Bus.is_pcc = True` | BoundaryIdentifier overlay |

**Rationale:** NetworkModel is physical topology. Results are transient calculation outputs.

---

## C. Tryby pracy SLD (Operating Modes)

**Referencja:** wizard_screens.md § 1.2, § 2.3

Tryby SLD są **1:1 zmapowane** na tryby systemowe Wizard:

| Tryb systemowy | Tryb SLD | Opis |
|----------------|----------|------|
| MODEL_EDIT | Tryb edycji | Pełna edycja topologii |
| CASE_CONFIG | Tryb edycji (model read-only) | Brak zmian topologii, konfiguracja przypadku |
| RESULT_VIEW | Tryb wyników | Tylko przeglądanie, nakładki aktywne |

### C.1 Tryb edycji (MODEL_EDIT / CASE_CONFIG)

W Trybie edycji SLD pozwala na modyfikację modelu (MODEL_EDIT) lub tylko przeglądanie (CASE_CONFIG):

| Akcja użytkownika | MODEL_EDIT | CASE_CONFIG |
|-------------------|------------|-------------|
| Kliknięcie symbolu | Zaznaczenie elementu | Zaznaczenie elementu |
| Podwójne kliknięcie | Otwórz Siatka Właściwości | Otwórz Siatka Właściwości (read-only) |
| Przeciąganie symbolu | Aktualizacja pozycji (tylko layout) | ZABLOKOWANE |
| Klawisz Delete | Usuń element z modelu | ZABLOKOWANE |
| Prawy przycisk | Menu kontekstowe (Dodaj/Edytuj/Usuń) | Menu kontekstowe (tylko Właściwości) |

**Stan w MODEL_EDIT:**
- Model: MUTOWALNY
- Wyniki: NIEAKTYWNE (unieważnione przy każdej zmianie)
- Nakładki: UKRYTE lub wyszarzone

### C.2 Tryb wyników (RESULT_VIEW)

W Trybie wyników SLD wyświetla wyniki bez możliwości edycji:

| Akcja użytkownika | Odpowiedź systemu |
|-------------------|-------------------|
| Kliknięcie symbolu | Pokaż szczegóły wyniku (tooltip/panel) |
| Podwójne kliknięcie | Otwórz Siatka Właściwości (TYLKO DO ODCZYTU) |
| Przeciąganie symbolu | ZABLOKOWANE |
| Klawisz Delete | ZABLOKOWANE |
| Prawy przycisk | Menu kontekstowe tylko do odczytu |

**Stan:**
- Model: TYLKO DO ODCZYTU
- Wyniki: WYŚWIETLANE (nakładki aktywne)
- Nakładki: Widoczne z adnotacjami

### C.3 Przełączanie trybów

```
MODEL_EDIT ◄─────────► CASE_CONFIG ◄─────────► RESULT_VIEW
     │                      │                       │
     │ Walidacja OK         │ Obliczenia sukces     │
     └──────────────────────┴───────────────────────┘
                    │
                    │ Użytkownik klika [Edytuj model]
                    └───────────────────────────────►
                         Ostrzeżenie: wyniki OUTDATED
```

**Reguły:**
- Przełączenie do MODEL_EDIT MOŻE unieważnić wyniki (ostrzeżenie dla użytkownika)
- Przełączenie do RESULT_VIEW WYMAGA prawidłowych wyników (stan FRESH)
- Jeśli wyniki są OUTDATED, poproś użytkownika o ponowne obliczenie

---

## D. Visual State Encoding

### D.1 Element States

| State | Visual Encoding |
|-------|-----------------|
| Normal (in_service=True) | Standard colors, solid lines |
| Out of service (in_service=False) | Gray, dashed lines |
| Selected | Highlight border, handles visible |
| Hover | Subtle highlight |
| Error (validation) | Red border/highlight |

### D.2 Switch States

| State | Symbol |
|-------|--------|
| CLOSED | Connected symbol (──●──) |
| OPEN | Disconnected symbol (── ──) |

### D.3 Result Overlays

| Analysis Result | Visual Encoding |
|-----------------|-----------------|
| Loading 0-80% | Green |
| Loading 80-100% | Yellow |
| Loading >100% | Red |
| Voltage normal | No marker |
| Voltage violation | Red marker |
| PCC boundary | Dashed boundary line (overlay) |

---

## E. Interaction Patterns

### E.1 Selection

| Action | Result |
|--------|--------|
| Single click | Select single element |
| Ctrl+click | Add to selection |
| Click empty area | Deselect all |
| Drag rectangle | Select enclosed elements |

### E.2 Context Menu (Edit Mode)

```
┌─────────────────────┐
│ Add Bus             │
│ Add Line            │
│ Add Transformer     │
│ ─────────────────── │
│ Properties...       │
│ ─────────────────── │
│ In Service     [✓]  │
│ ─────────────────── │
│ Delete              │
└─────────────────────┘
```

### E.3 Context Menu (Result Mode)

```
┌─────────────────────┐
│ View Properties...  │
│ ─────────────────── │
│ Show Results Detail │
│ Export Results...   │
└─────────────────────┘
```

---

## F. Converter-Based Sources (PV/WIND/BESS) — SLD Rules

### F.1 Symbolika i mapowanie (Symbol Mapping)

Źródła konwerterowe (PV, WIND, BESS) są reprezentowane jako warianty symbolu Source:

| Typ źródła | Symbol SLD | Obiekt modelu | Opis |
|------------|------------|---------------|------|
| **PV** | SourceSymbol (wariant PV) | Source (converter_kind=PV) | Fotowoltaika |
| **WIND** | SourceSymbol (wariant WIND) | Source (converter_kind=WIND) | Elektrownia wiatrowa |
| **BESS** | SourceSymbol (wariant BESS) | Source (converter_kind=BESS) | Magazyn energii |

**INVARIANT (1:1 Mapping):** Każdy symbol źródła konwerterowego odpowiada dokładnie jednemu obiektowi Source w NetworkModel. Brak helper objects.

### F.2 Etykieta symbolu (Symbol Label)

Etykieta źródła konwerterowego MUSI zawierać:

```
┌─────────────────────────────┐
│ [Nazwa] ([Typ])             │
│ Sn = [wartość] MVA          │
│ Un = [wartość] kV           │
└─────────────────────────────┘
```

| Element etykiety | Źródło danych | Przykład |
|------------------|---------------|----------|
| Nazwa | Source.name | "PV-DACH-01" |
| Typ | Source.converter_kind | "PV" / "WIND" / "BESS" |
| Sn | Catalog (type_ref) | "2.5 MVA" |
| Un | Catalog (type_ref) | "0.4 kV" |

**Determinizm:** Kolejność elementów etykiety jest stała. Kolejność legend i list źródeł MUSI być deterministyczna (np. alfabetycznie po nazwie).

### F.3 Stany i widoczność (States and Visibility)

#### F.3.1 Stan `in_service`

| `in_service` | Widoczność SLD | Solver | Opis |
|--------------|----------------|--------|------|
| `True` | Normalny wygląd | Uwzględniony | Element aktywny |
| `False` | Wyszarzony, linia przerywana | Pominięty | Element wyłączony z obliczeń |

**Reguła:** Element z `in_service = False` pozostaje widoczny na SLD, ale solver go nie widzi.

#### F.3.2 Brak impedancji w symbolu

Symbol źródła konwerterowego NIE zawiera impedancji. Parametry pracy (P, Q, cosφ) nie zmieniają topologii sieci — wpływają wyłącznie na bilans mocy.

### F.4 Result Overlays (RESULT_VIEW)

W trybie RESULT_VIEW overlay dla źródła konwerterowego pokazuje:

| Parametr | Jednostka | Opis |
|----------|-----------|------|
| P | MW | Moc czynna (wynik obliczeń) |
| Q | Mvar | Moc bierna (wynik obliczeń) |
| I | A | Prąd wypływający |
| Kierunek | → / ← | Kierunek przepływu mocy |

#### F.4.1 BESS — interpretacja znaku P w overlay

| Wynik P | Oznaczenie overlay | Interpretacja |
|---------|-------------------|---------------|
| P > 0 | → (strzałka od BESS) | Rozładowanie — eksport do sieci |
| P < 0 | ← (strzałka do BESS) | Ładowanie — pobór z sieci |

#### F.4.2 Status wyników (Result Freshness)

Overlay MUSI wskazywać status wyników:

| Status | Oznaczenie UX | Opis |
|--------|---------------|------|
| **VALID** | Normalny kolor | Wyniki aktualne względem modelu |
| **OUTDATED** | Wyszarzenie / ostrzeżenie | Model zmieniony od ostatniego obliczenia |

### F.5 Zakazy (Prohibitions)

#### F.5.1 PCC – punkt wspólnego przyłączenia

**BINDING:** PCC NIE istnieje w NetworkModel ani jako obiekt SLD.

| Warstwa | Status PCC |
|---------|------------|
| NetworkModel | ZABRONIONY |
| SLD (symbol) | ZABRONIONY |
| Analysis (overlay) | DOZWOLONY — wyłącznie jako wynik analizy |

PCC może być wyświetlony wyłącznie jako overlay pochodzący z warstwy Analysis (BoundaryIdentifier), nigdy jako obiekt modelu.

#### F.5.2 Regulatorów i trybów dynamicznych

**ZABRONIONE w SLD (tryb statyczny):**
- Volt-VAR, Volt-Watt, droop
- Modele dynamiczne (RMS/EMT)
- Regulatory napięcia/mocy biernej
- Parametry inercji i stałych czasowych

### F.6 Deterministyczna prezentacja (Deterministic Display)

| Element | Reguła sortowania |
|---------|-------------------|
| Lista źródeł w panelu | Alfabetycznie po nazwie |
| Legenda typów | Kolejność: PV → WIND → BESS |
| Etykiety na diagramie | Stała pozycja względem symbolu |
| Overlay wyników | Stała kolejność: P, Q, I |

**INVARIANT:** Identyczny model MUSI generować identyczny widok SLD przy każdym renderowaniu.

---

## G. Integracja SLD ↔ Wizard

**Referencja:** wizard_screens.md § 2.3, § 4

### G.1 Zaznaczenie obiektu

| Akcja w SLD | Reakcja Wizard |
|-------------|----------------|
| Kliknięcie symbolu | Zaznaczenie w Drzewie Projektu + Siatka Właściwości pokazuje obiekt |
| Podwójne kliknięcie symbolu | Fokus na Siatka Właściwości z możliwością edycji (tryb MODEL_EDIT) |
| Zaznaczenie w Drzewie Projektu | Podświetlenie symbolu na SLD |

### G.2 Menu kontekstowe — mapowanie trybów

| Tryb | Dostępne opcje menu kontekstowego |
|------|-----------------------------------|
| MODEL_EDIT | Dodaj szynę, Dodaj linię, Dodaj transformator, Właściwości..., W eksploatacji [✓], Usuń |
| CASE_CONFIG | Właściwości... (read-only) |
| RESULT_VIEW | Pokaż właściwości..., Pokaż szczegóły wyników, Eksportuj wyniki... |

### G.3 Zakaz wirtualnych symboli

**BINDING (zgodnie z wizard_screens.md § 6.8.6):**

| Element | Status w NetworkModel | Status w SLD |
|---------|----------------------|--------------|
| Szyna (Bus) | Obiekt modelu | Symbol obowiązkowy |
| Linia (LineBranch) | Obiekt modelu | Symbol obowiązkowy |
| PCC – punkt wspólnego przyłączenia | **ZABRONIONY** | **ZABRONIONY** — wyłącznie overlay z Analysis |
| Granica sieci (Boundary) | **ZABRONIONY** | **ZABRONIONY** — wyłącznie overlay |

**INVARIANT:** PCC może być wyświetlony wyłącznie jako **nakładka wyników** (overlay) pochodząca z warstwy Analysis (np. BoundaryIdentifier), nigdy jako obiekt NetworkModel ani symbol bazowy SLD.

---

**KONIEC SPECYFIKACJI REGUŁ SLD**
