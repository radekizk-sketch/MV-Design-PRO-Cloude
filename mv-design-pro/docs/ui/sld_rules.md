# SLD (Single Line Diagram) Rules

**Reference:** SYSTEM_SPEC.md Section 9, Section 18
**Status:** CANONICAL

---

## A. Zasady SLD (SLD Principles)

### A.1 Bijection: Symbol ↔ Model Object

**INVARIANT:** Each SLD symbol corresponds to exactly ONE NetworkModel object.

```
┌─────────────────────────────────────────────────────────────┐
│                     NetworkModel                             │
│  ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐        │
│  │ Bus_1 │ │ Bus_2 │ │Line_1 │ │Trafo_1│ │Source1│        │
│  └───────┘ └───────┘ └───────┘ └───────┘ └───────┘        │
│      ↕         ↕         ↕         ↕         ↕             │
│  ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐        │
│  │Symbol │ │Symbol │ │Symbol │ │Symbol │ │Symbol │        │
│  │ Bus_1 │ │ Bus_2 │ │Line_1 │ │Trafo_1│ │Source1│        │
│  └───────┘ └───────┘ └───────┘ └───────┘ └───────┘        │
│                        SLD Layer                            │
└─────────────────────────────────────────────────────────────┘
```

### A.2 Symbol Types

| Model Object | SLD Symbol | Visual Representation |
|--------------|------------|----------------------|
| Bus | BusSymbol | Horizontal bar (busbar) |
| LineBranch | LineSymbol | Single line with markers |
| TransformerBranch | TransformerSymbol | Circle(s) with windings |
| Switch | SwitchSymbol | Break symbol (open/closed) |
| Source | SourceSymbol | Circle with arrow (grid) |
| Load | LoadSymbol | Triangle (consumption) |

### A.3 No Helper Objects

**FORBIDDEN:**
- Junction points not backed by Bus
- Connection lines not backed by Branch
- Annotation symbols with implicit meaning
- Grouping frames with electrical meaning

**ALLOWED:**
- Text labels (pure annotation, no semantics)
- Position coordinates (layout only)
- Layer/grouping for visual organization (no electrical meaning)

### A.4 No Virtual Symbols

**FORBIDDEN:**

| Virtual Symbol | Why Forbidden | Correct Approach |
|----------------|---------------|------------------|
| "Virtual Bus" | No model object | Add real Bus to model |
| "PCC Marker" | PCC is interpretation | Analysis overlay |
| "Boundary Line" | No physical meaning | Analysis overlay |
| "Aggregated Feeder" | Hides topology | Show individual elements |

---

## B. Wyniki (Results Display)

### B.1 Results as Overlay

Solver results MUST be displayed as overlay on SLD, NOT as modifications to symbols:

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   Base Layer (SLD Symbols):                                 │
│                                                             │
│   ════╦════════════════════╦════                           │
│       ║                    ║                                │
│                                                             │
│   Overlay Layer (Results):                                  │
│                                                             │
│      [I=125A]           [I=98A]                            │
│      [U=14.8kV]         [U=15.1kV]                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### B.2 Overlay = Analysis Layer

Result overlays are generated by Analysis layer, not by Solver:

| Data Source | Overlay Type | Content |
|-------------|--------------|---------|
| PowerFlowResult | Current annotations | I values at branches |
| PowerFlowResult | Voltage annotations | U values at buses |
| ThermalAnalysis | Loading colors | Red/yellow/green |
| VoltageAnalysis | Violation markers | Over/under voltage |
| BoundaryIdentifier | PCC marker | Boundary indicator |

### B.3 No Results in Model

**BINDING:** Solver results MUST NOT be written to NetworkModel:

| Forbidden | Correct Approach |
|-----------|------------------|
| `Bus.calculated_voltage = 14.8` | Store in PowerFlowResult |
| `Branch.calculated_current = 125` | Store in PowerFlowResult |
| `Bus.is_pcc = True` | BoundaryIdentifier overlay |

**Rationale:** NetworkModel is physical topology. Results are transient calculation outputs.

---

## C. Tryby (Operating Modes)

### C.1 Edit Mode

In Edit Mode, SLD allows model modification:

| User Action | System Response |
|-------------|-----------------|
| Click symbol | Select element |
| Double-click | Open Properties |
| Drag symbol | Update position (layout only) |
| Delete key | Remove element from model |
| Right-click | Context menu (Add/Edit/Delete) |

**State:**
- Model: MUTABLE
- Results: N/A (invalidated on change)
- Overlays: Hidden or grayed

### C.2 Result Mode (Read-only)

In Result Mode, SLD displays results without allowing edits:

| User Action | System Response |
|-------------|-----------------|
| Click symbol | Show result details (tooltip/panel) |
| Double-click | Open Properties (READ-ONLY) |
| Drag symbol | BLOCKED |
| Delete key | BLOCKED |
| Right-click | View-only context menu |

**State:**
- Model: READ-ONLY
- Results: DISPLAYED (overlays active)
- Overlays: Visible with annotations

### C.3 Mode Switching

```
Edit Mode ◄────────────────────► Result Mode
              │                       │
              │ User runs calculation │
              └───────────────────────┘
              │                       │
              │ User clicks "Edit"    │
              └───────────────────────┘
```

**Rules:**
- Switching to Edit Mode MAY invalidate results (user warned)
- Switching to Result Mode REQUIRES valid results (FRESH state)
- If results are OUTDATED, prompt user to recalculate

---

## D. Visual State Encoding

### D.1 Element States

| State | Visual Encoding |
|-------|-----------------|
| Normal (in_service=True) | Standard colors, solid lines |
| Out of service (in_service=False) | Gray, dashed lines |
| Selected | Highlight border, handles visible |
| Hover | Subtle highlight |
| Error (validation) | Red border/highlight |

### D.2 Switch States

| State | Symbol |
|-------|--------|
| CLOSED | Connected symbol (──●──) |
| OPEN | Disconnected symbol (── ──) |

### D.3 Result Overlays

| Analysis Result | Visual Encoding |
|-----------------|-----------------|
| Loading 0-80% | Green |
| Loading 80-100% | Yellow |
| Loading >100% | Red |
| Voltage normal | No marker |
| Voltage violation | Red marker |
| PCC boundary | Dashed boundary line (overlay) |

---

## E. Interaction Patterns

### E.1 Selection

| Action | Result |
|--------|--------|
| Single click | Select single element |
| Ctrl+click | Add to selection |
| Click empty area | Deselect all |
| Drag rectangle | Select enclosed elements |

### E.2 Context Menu (Edit Mode)

```
┌─────────────────────┐
│ Add Bus             │
│ Add Line            │
│ Add Transformer     │
│ ─────────────────── │
│ Properties...       │
│ ─────────────────── │
│ In Service     [✓]  │
│ ─────────────────── │
│ Delete              │
└─────────────────────┘
```

### E.3 Context Menu (Result Mode)

```
┌─────────────────────┐
│ View Properties...  │
│ ─────────────────── │
│ Show Results Detail │
│ Export Results...   │
└─────────────────────┘
```

---

**END OF SLD RULES SPECIFICATION**
